from django.db import migrations

def populate_classes(apps, schema_editor):
    # App name is 'base'
    CharacterClass = apps.get_model('base', 'CharacterClass') 
    ClassSpellProgression = apps.get_model('base', 'ClassSpellProgression')
    
    # Data Structure: 
    # (Name, HitDie, Ability, Prepared?, PrepMultiplier, Progression)
    # Progression: List of tuples (cantrips, known, [slot1, slot2, ... slot9])
    
    classes_data = [
        {
            "name": "Barbarian", "hit_die": 12, "ability": None, "prepared": False, "prep_mult": 0.0,
            "progression": [ (0, 0, [0]*9) for _ in range(20) ]
        },
        {
            "name": "Bard", "hit_die": 8, "ability": "charisma", "prepared": False, "prep_mult": 0.0,
            "progression": [
                (2, 4, [2,0,0,0,0,0,0,0,0]), (2, 5, [3,0,0,0,0,0,0,0,0]), (2, 6, [4,2,0,0,0,0,0,0,0]), (3, 7, [4,3,0,0,0,0,0,0,0]),
                (3, 8, [4,3,2,0,0,0,0,0,0]), (3, 9, [4,3,3,0,0,0,0,0,0]), (3, 10, [4,3,3,1,0,0,0,0,0]), (3, 11, [4,3,3,2,0,0,0,0,0]),
                (3, 12, [4,3,3,3,1,0,0,0,0]), (4, 14, [4,3,3,3,2,0,0,0,0]), (4, 15, [4,3,3,3,2,1,0,0,0]), (4, 15, [4,3,3,3,2,1,0,0,0]),
                (4, 16, [4,3,3,3,2,1,1,0,0]), (4, 18, [4,3,3,3,2,1,1,0,0]), (4, 19, [4,3,3,3,2,1,1,1,0]), (4, 19, [4,3,3,3,2,1,1,1,0]),
                (4, 20, [4,3,3,3,2,1,1,1,1]), (4, 22, [4,3,3,3,3,1,1,1,1]), (4, 22, [4,3,3,3,3,2,1,1,1]), (4, 22, [4,3,3,3,3,2,2,1,1])
            ]
        },
        {
            "name": "Cleric", "hit_die": 8, "ability": "wisdom", "prepared": True, "prep_mult": 1.0,
            "progression": [
                (3, 0, [2,0,0,0,0,0,0,0,0]), (3, 0, [3,0,0,0,0,0,0,0,0]), (3, 0, [4,2,0,0,0,0,0,0,0]), (4, 0, [4,3,0,0,0,0,0,0,0]),
                (4, 0, [4,3,2,0,0,0,0,0,0]), (4, 0, [4,3,3,0,0,0,0,0,0]), (4, 0, [4,3,3,1,0,0,0,0,0]), (4, 0, [4,3,3,2,0,0,0,0,0]),
                (4, 0, [4,3,3,3,1,0,0,0,0]), (5, 0, [4,3,3,3,2,0,0,0,0]), (5, 0, [4,3,3,3,2,1,0,0,0]), (5, 0, [4,3,3,3,2,1,0,0,0]),
                (5, 0, [4,3,3,3,2,1,1,0,0]), (5, 0, [4,3,3,3,2,1,1,0,0]), (5, 0, [4,3,3,3,2,1,1,1,0]), (5, 0, [4,3,3,3,2,1,1,1,0]),
                (5, 0, [4,3,3,3,2,1,1,1,1]), (5, 0, [4,3,3,3,3,1,1,1,1]), (5, 0, [4,3,3,3,3,2,1,1,1]), (5, 0, [4,3,3,3,3,2,2,1,1])
            ]
        },
        {
            "name": "Druid", "hit_die": 8, "ability": "wisdom", "prepared": True, "prep_mult": 1.0,
            "progression": [
                (2, 0, [2,0,0,0,0,0,0,0,0]), (2, 0, [3,0,0,0,0,0,0,0,0]), (2, 0, [4,2,0,0,0,0,0,0,0]), (3, 0, [4,3,0,0,0,0,0,0,0]),
                (3, 0, [4,3,2,0,0,0,0,0,0]), (3, 0, [4,3,3,0,0,0,0,0,0]), (3, 0, [4,3,3,1,0,0,0,0,0]), (3, 0, [4,3,3,2,0,0,0,0,0]),
                (3, 0, [4,3,3,3,1,0,0,0,0]), (4, 0, [4,3,3,3,2,0,0,0,0]), (4, 0, [4,3,3,3,2,1,0,0,0]), (4, 0, [4,3,3,3,2,1,0,0,0]),
                (4, 0, [4,3,3,3,2,1,1,0,0]), (4, 0, [4,3,3,3,2,1,1,0,0]), (4, 0, [4,3,3,3,2,1,1,1,0]), (4, 0, [4,3,3,3,2,1,1,1,0]),
                (4, 0, [4,3,3,3,2,1,1,1,1]), (4, 0, [4,3,3,3,3,1,1,1,1]), (4, 0, [4,3,3,3,3,2,1,1,1]), (4, 0, [4,3,3,3,3,2,2,1,1])
            ]
        },
        {
            "name": "Fighter", "hit_die": 10, "ability": None, "prepared": False, "prep_mult": 0.0,
            "progression": [ (0, 0, [0]*9) for _ in range(20) ]
        },
        {
            "name": "Monk", "hit_die": 8, "ability": None, "prepared": False, "prep_mult": 0.0,
            "progression": [ (0, 0, [0]*9) for _ in range(20) ]
        },
        {
            "name": "Paladin", "hit_die": 10, "ability": "charisma", "prepared": True, "prep_mult": 0.5,
            "progression": [
                (0, 0, [0,0,0,0,0,0,0,0,0]), (0, 0, [2,0,0,0,0,0,0,0,0]), (0, 0, [3,0,0,0,0,0,0,0,0]), (0, 0, [3,0,0,0,0,0,0,0,0]),
                (0, 0, [4,2,0,0,0,0,0,0,0]), (0, 0, [4,2,0,0,0,0,0,0,0]), (0, 0, [4,3,0,0,0,0,0,0,0]), (0, 0, [4,3,0,0,0,0,0,0,0]),
                (0, 0, [4,3,2,0,0,0,0,0,0]), (0, 0, [4,3,2,0,0,0,0,0,0]), (0, 0, [4,3,3,0,0,0,0,0,0]), (0, 0, [4,3,3,0,0,0,0,0,0]),
                (0, 0, [4,3,3,1,0,0,0,0,0]), (0, 0, [4,3,3,1,0,0,0,0,0]), (0, 0, [4,3,3,2,0,0,0,0,0]), (0, 0, [4,3,3,2,0,0,0,0,0]),
                (0, 0, [4,3,3,3,1,0,0,0,0]), (0, 0, [4,3,3,3,1,0,0,0,0]), (0, 0, [4,3,3,3,2,0,0,0,0]), (0, 0, [4,3,3,3,2,0,0,0,0])
            ]
        },
        {
            "name": "Ranger", "hit_die": 10, "ability": "wisdom", "prepared": False, "prep_mult": 0.0,
            "progression": [
                (0, 0, [0,0,0,0,0,0,0,0,0]), (0, 2, [2,0,0,0,0,0,0,0,0]), (0, 3, [3,0,0,0,0,0,0,0,0]), (0, 3, [3,0,0,0,0,0,0,0,0]),
                (0, 4, [4,2,0,0,0,0,0,0,0]), (0, 4, [4,2,0,0,0,0,0,0,0]), (0, 5, [4,3,0,0,0,0,0,0,0]), (0, 5, [4,3,0,0,0,0,0,0,0]),
                (0, 6, [4,3,2,0,0,0,0,0,0]), (0, 6, [4,3,2,0,0,0,0,0,0]), (0, 7, [4,3,3,0,0,0,0,0,0]), (0, 7, [4,3,3,0,0,0,0,0,0]),
                (0, 8, [4,3,3,1,0,0,0,0,0]), (0, 8, [4,3,3,1,0,0,0,0,0]), (0, 9, [4,3,3,2,0,0,0,0,0]), (0, 9, [4,3,3,2,0,0,0,0,0]),
                (0, 10, [4,3,3,3,1,0,0,0,0]), (0, 10, [4,3,3,3,1,0,0,0,0]), (0, 11, [4,3,3,3,2,0,0,0,0]), (0, 11, [4,3,3,3,2,0,0,0,0])
            ]
        },
        {
            "name": "Rogue", "hit_die": 8, "ability": None, "prepared": False, "prep_mult": 0.0,
            "progression": [ (0, 0, [0]*9) for _ in range(20) ]
        },
        {
            "name": "Sorcerer", "hit_die": 6, "ability": "charisma", "prepared": False, "prep_mult": 0.0,
            "progression": [
                (4, 2, [2,0,0,0,0,0,0,0,0]), (4, 3, [3,0,0,0,0,0,0,0,0]), (4, 4, [4,2,0,0,0,0,0,0,0]), (5, 5, [4,3,0,0,0,0,0,0,0]),
                (5, 6, [4,3,2,0,0,0,0,0,0]), (5, 7, [4,3,3,0,0,0,0,0,0]), (5, 8, [4,3,3,1,0,0,0,0,0]), (5, 9, [4,3,3,2,0,0,0,0,0]),
                (5, 10, [4,3,3,3,1,0,0,0,0]), (6, 11, [4,3,3,3,2,0,0,0,0]), (6, 12, [4,3,3,3,2,1,0,0,0]), (6, 12, [4,3,3,3,2,1,0,0,0]),
                (6, 13, [4,3,3,3,2,1,1,0,0]), (6, 13, [4,3,3,3,2,1,1,0,0]), (6, 14, [4,3,3,3,2,1,1,1,0]), (6, 14, [4,3,3,3,2,1,1,1,0]),
                (6, 15, [4,3,3,3,2,1,1,1,1]), (6, 15, [4,3,3,3,3,1,1,1,1]), (6, 15, [4,3,3,3,3,2,1,1,1]), (6, 15, [4,3,3,3,3,2,2,1,1])
            ]
        },
        {
            "name": "Warlock", "hit_die": 8, "ability": "charisma", "prepared": False, "prep_mult": 0.0,
            "progression": [
                (2, 2, [1,0,0,0,0,0,0,0,0]), (2, 3, [2,0,0,0,0,0,0,0,0]), (2, 4, [0,2,0,0,0,0,0,0,0]), (3, 5, [0,2,0,0,0,0,0,0,0]),
                (3, 6, [0,0,2,0,0,0,0,0,0]), (3, 7, [0,0,2,0,0,0,0,0,0]), (3, 8, [0,0,0,2,0,0,0,0,0]), (3, 9, [0,0,0,2,0,0,0,0,0]),
                (3, 10, [0,0,0,0,2,0,0,0,0]), (4, 10, [0,0,0,0,2,0,0,0,0]), (4, 11, [0,0,0,0,3,0,0,0,0]), (4, 11, [0,0,0,0,3,0,0,0,0]),
                (4, 12, [0,0,0,0,3,0,0,0,0]), (4, 12, [0,0,0,0,3,0,0,0,0]), (4, 13, [0,0,0,0,3,0,0,0,0]), (4, 13, [0,0,0,0,3,0,0,0,0]),
                (4, 14, [0,0,0,0,4,0,0,0,0]), (4, 14, [0,0,0,0,4,0,0,0,0]), (4, 15, [0,0,0,0,4,0,0,0,0]), (4, 15, [0,0,0,0,4,0,0,0,0])
            ]
        },
        {
            "name": "Wizard", "hit_die": 6, "ability": "intelligence", "prepared": True, "prep_mult": 1.0,
            "progression": [
                (3, 0, [2,0,0,0,0,0,0,0,0]), (3, 0, [3,0,0,0,0,0,0,0,0]), (3, 0, [4,2,0,0,0,0,0,0,0]), (4, 0, [4,3,0,0,0,0,0,0,0]),
                (4, 0, [4,3,2,0,0,0,0,0,0]), (4, 0, [4,3,3,0,0,0,0,0,0]), (4, 0, [4,3,3,1,0,0,0,0,0]), (4, 0, [4,3,3,2,0,0,0,0,0]),
                (4, 0, [4,3,3,3,1,0,0,0,0]), (5, 0, [4,3,3,3,2,0,0,0,0]), (5, 0, [4,3,3,3,2,1,0,0,0]), (5, 0, [4,3,3,3,2,1,0,0,0]),
                (5, 0, [4,3,3,3,2,1,1,0,0]), (5, 0, [4,3,3,3,2,1,1,0,0]), (5, 0, [4,3,3,3,2,1,1,1,0]), (5, 0, [4,3,3,3,2,1,1,1,0]),
                (5, 0, [4,3,3,3,2,1,1,1,1]), (5, 0, [4,3,3,3,3,1,1,1,1]), (5, 0, [4,3,3,3,3,2,1,1,1]), (5, 0, [4,3,3,3,3,2,2,1,1])
            ]
        }
    ]

    for data in classes_data:
        c_class, created = CharacterClass.objects.get_or_create(
            name=data["name"],
            defaults={
                "hit_die": data["hit_die"],
                "spellcasting_ability": data["ability"],
                "is_prepared_caster": data["prepared"],
                "preparation_multiplier": data["prep_mult"]
            }
        )
        
        # Always update in case fields changed
        c_class.hit_die = data["hit_die"]
        c_class.spellcasting_ability = data["ability"]
        c_class.is_prepared_caster = data["prepared"]
        c_class.preparation_multiplier = data["prep_mult"]
        c_class.save()

        # Create/Update Progression for levels 1-20
        for lvl_idx, (cantrips, known, slots) in enumerate(data["progression"]):
            level = lvl_idx + 1
            ClassSpellProgression.objects.update_or_create(
                character_class=c_class,
                level=level,
                defaults={
                    "cantrips_known": cantrips,
                    "spells_known": known,
                    "slots_level_1": slots[0],
                    "slots_level_2": slots[1],
                    "slots_level_3": slots[2],
                    "slots_level_4": slots[3],
                    "slots_level_5": slots[4],
                    "slots_level_6": slots[5],
                    "slots_level_7": slots[6],
                    "slots_level_8": slots[7],
                    "slots_level_9": slots[8],
                }
            )

class Migration(migrations.Migration):

    dependencies = [
        # AUTOMATICALLY GENERATED BY DJANGO, DO NOT CHANGE
        ('base', '0016_characterclass_hit_die_and_more'), 
    ]

    operations = [
        migrations.RunPython(populate_classes),
    ]