<h1>Character detail: {{ character.character_name }}</h1>

{% if character %}
<div class="mb-3">
    <a href="{% url 'characters' %}" class="btn btn-sm btn-outline-secondary">Back to list</a>
    <a href="{% url 'character-update' character.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
    
    <a href="{% url 'character-delete' character.pk %}" class="btn btn-sm btn-outline-danger">Delete</a>

    {% if character.character_class.spells.exists %}
        <a href="{% url 'character_spells' character.pk %}" class="btn btn-sm btn-warning fw-bold ms-2">
            âœ¨ Manage Spells
        </a>
    {% endif %}
</div>
{% endif %}

<style>
  .detail-table { border-collapse: collapse; width: 100%; max-width: 900px; box-shadow: 0 0 0 1px #444; }
  .detail-table th, .detail-table td { border: 1px solid #444; padding: 8px 10px; vertical-align: top; }
  .detail-table th { background:#f4f4f4; text-align:left; width: 220px; }
  .detail-table td.backstory { white-space: pre-wrap; }
  .meta { margin-top: 12px; color: #666; font-size: 0.9em }
</style>

{% if character %}
  <table class="detail-table">
    <tbody>
      <tr><th>Name</th><td>{{ character.character_name }}</td></tr>
      <tr><th>Player</th><td>{% if character.user.username %}{{ character.user.username }}{% else %}{{ character.user }}{% endif %}</td></tr>
      <tr><th>Class</th><td>{% if character.get_character_class_display %}{{ character.get_character_class_display }}{% else %}{{ character.character_class }}{% endif %}</td></tr>
      <tr><th>Subclass</th><td>{% if character.subclass and character.subclass.name %}{{ character.subclass.name }}{% else %}{% if character.subclass %}{{ character.subclass }}{% else %}-{% endif %}{% endif %}</td></tr>
      <tr><th>Race</th><td>{% if character.race %}{{ character.race.name }}{% else %}-{% endif %}</td></tr>
      <tr><th>Level</th><td>{{ character.level }}</td></tr>
      <tr><th>Background</th><td>{% if character.get_background_display %}{{ character.get_background_display }}{% else %}{{ character.background }}{% endif %}</td></tr>
      <tr><th>Alignment</th><td>{% if character.get_alignment_display %}{{ character.get_alignment_display }}{% else %}{{ character.alignment }}{% endif %}</td></tr>
      <tr><th>Experience points</th><td>{{ character.experience_points|default:'-' }}</td></tr>
      <tr><th>Strength</th><td>{{ character.strength }}</td></tr>
      <tr><th>Dexterity</th><td>{{ character.dexterity }}</td></tr>
      <tr><th>Constitution</th><td>{{ character.constitution }}</td></tr>
      <tr><th>Intelligence</th><td>{{ character.intelligence }}</td></tr>
      <tr><th>Wisdom</th><td>{{ character.wisdom }}</td></tr>
      <tr><th>Charisma</th><td>{{ character.charisma }}</td></tr>
      <tr><th>Armor Class</th><td>{{ character.armor_class }}</td></tr>
      <tr><th>Initiative</th><td>{{ character.initiative }}</td></tr>
      <tr><th>Speed</th><td>{{ character.speed }}</td></tr>
      <tr><th>Hit Points</th><td>{{ character.hit_points }}</td></tr>
      <tr><th>Temporary HP</th><td>{{ character.temporary_hit_points }}</td></tr>
      <tr><th>Hit Dice</th><td>{{ character.hit_dice }}</td></tr>
      <tr><th>Death Saves (S / F)</th><td>{{ character.death_saves_success|default:'-' }} / {{ character.death_saves_failure|default:'-' }}</td></tr>
      <tr><th>Inspiration</th><td>{% if character.inspiration %}Yes{% else %}No{% endif %}</td></tr>
      <tr><th>Languages</th>
        <td>
          {% for lang in character.languages.all %}
            {{ lang.name }}{% if not forloop.last %}, {% endif %}
          {% empty %}
            -
          {% endfor %}
        </td>
      </tr>
      <tr><th>Backstory</th><td class="backstory">{{ character.backstory|linebreaksbr|default:'-' }}</td></tr>
      <tr><th>Created at</th><td>{{ character.created_at|date:"Y-m-d H:i" }}</td></tr>
    </tbody>
  </table>

  <h2>Inventory</h2>
  {% if inventory %}
    <table class="detail-table">
      <thead>
        <tr><th>Item</th><th>Quantity</th><th>Weight (each)</th>
      </thead>
      <tbody>
        {% for inv in inventory %}
          <tr>
            <td>{{ inv.item.name }}</td>
            <td>{{ inv.quantity }}</td>
            <td>{{ inv.item.weight }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No items in inventory.</p>
  {% endif %}


  {% if background_obj %}
  <h2>Background: {{ background_obj.name }}</h2>

  <p><strong>Description:</strong><br>
     {{ background_obj.description }}</p>

  <p><strong>Feature - {{ background_obj.feature_name }}:</strong><br>
     {{ background_obj.feature_description }}</p>
{% endif %}


{% if background_obj.backgroundtoolproficiency_set.all %}
  <h3>Tool Proficiencies</h3>
  <ul>
    {% for prof in background_obj.backgroundtoolproficiency_set.all %}
      <li>{{ prof.tool.name }}</li>
    {% endfor %}
  </ul>
{% endif %}


{% if background_obj.backgroundstartingequipment_set.all %}
  <h3>Background Equipment</h3>
  <ul>
    {% for eq in background_obj.backgroundstartingequipment_set.all %}
      <li>{{ eq.item.name }} x {{ eq.quantity }}</li>
    {% endfor %}
  </ul>
{% endif %}

<h2>Skills</h2>
<table class="detail-table">
  <thead>
    <tr>
      <th>Skill</th>
      <th>Ability</th>
      <th>Proficient</th>
      <th>Bonus</th>
    </tr>
  </thead>
  <tbody>
    {% for row in skills_data %}
      <tr>
        <td>{{ row.skill.name }}</td>
        <td>{{ row.ability }}</td>
        <td>{% if row.is_proficient %}âœ“{% else %}â€”{% endif %}</td>
        <td>{{ row.bonus }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

<h2 style="margin-top: 40px;">Class Features</h2>

{% with features=character.get_class_features %}
{% if features %}
  {% for feature in features %}
    <div style="margin-bottom: 16px;">
      <strong>
        {{ feature.name }}
        <span style="color:#666;">(Level {{ feature.unlock_level }})</span>
      </strong>
      {% if feature.subclass %}
        <em style="color:#888;"> â€“ {{ feature.subclass.name }}</em>
      {% endif %}
      <p style="margin-top: 4px;">
        {{ feature.description|linebreaksbr }}
      </p>
    </div>
  {% endfor %}
{% else %}
  <p>This class has no features defined or unlocked yet.</p>
{% endif %}
{% endwith %}

<h2 style="margin-top: 40px;">Feats</h2>
{% if character.feats.all %}
    <ul style="list-style-type: disc; padding-left: 20px;">
    {% for feat in character.feats.all %}
        <li style="margin-bottom: 10px;">
            <strong>{{ feat.name }}</strong>
            {% if feat.prerequisite %}
                <span style="color: #666; font-size: 0.9em;">(Prereq: {{ feat.prerequisite }})</span>
            {% endif %}
            <br>
            {{ feat.description }}
        </li>
    {% endfor %}
    </ul>
{% else %}
    <p>No feats selected.</p>
{% endif %}

<h2 style="margin-top: 40px;">Spellbook</h2>

{% if character.spells.exists %}
    
    {% regroup character.spells.all|dictsort:"level" by level as spell_levels %}

    {% for level_group in spell_levels %}
        <h4 style="margin-top: 20px; color: #444;">
            {% if level_group.grouper == 0 %} 
                ðŸ”® Cantrips (0 Level)
            {% else %} 
                âš¡ Level {{ level_group.grouper }} 
            {% endif %}
        </h4>

        <table class="detail-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>School</th>
                    <th>Casting Time</th>
                    <th>Range</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody>
                {% for spell in level_group.list %}
                <tr>
                    <td><strong>{{ spell.name }}</strong></td>
                    <td>{{ spell.school }}</td>
                    <td>{{ spell.casting_time }}</td>
                    <td>{{ spell.range }}</td>
                    <td>
                        {{ spell.duration }}
                        {% if spell.concentration %} (C){% endif %}
                        {% if spell.ritual %} (R){% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endfor %}

{% else %}
    {% if character.character_class.spells.exists %}
        <p>This character knows magic but hasn't prepared any spells yet. 
           <a href="{% url 'character_spells' character.pk %}">Click here to manage spells.</a>
        </p>
    {% else %}
        <p>This character has no magical abilities.</p>
    {% endif %}
{% endif %}

{% else %}
  <p>Character not found.</p>
{% endif %}