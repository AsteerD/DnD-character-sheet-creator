<h1>
  {% if form.instance.pk %}Edit Character{% else %}Create Character{% endif %}
</h1>

<form method="POST" action="">
  {% csrf_token %}
  
  <button type="submit">
    {% if form.instance.pk %}Save{% else %}Create{% endif %}
  </button>

  {{ form.as_p }}

  <button type="submit">
    {% if form.instance.pk %}Save{% else %}Create{% endif %}
  </button>
</form>

<p><a href="{% url 'characters' %}">Back to list</a></p>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const classSelect = document.getElementById("id_character_class");
    const subclassSelect = document.getElementById("id_subclass");
    const skillsContainer = document.querySelector('#id_skills');

    function updateSubclasses(classId) {
        subclassSelect.innerHTML = "<option value=''>---------</option>";
        if (!classId) return;

        fetch(`/ajax/subclasses/?class_id=${classId}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(subclass => {
                    const opt = document.createElement("option");
                    opt.value = subclass.id;
                    opt.textContent = subclass.name;
                    subclassSelect.appendChild(opt);
                });
            });
    }

    function updateSkills(classId) {
        if (!skillsContainer) return;
        
        fetch(`/skills-for-class/?class_id=${classId}`)
            .then(response => response.json())
            .then(data => {
                skillsContainer.innerHTML = '';
                data.forEach(skill => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.name = 'skills';
                    input.value = skill.id;
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(' ' + skill.name));
                    skillsContainer.appendChild(label);
                });
            });
    }

    classSelect.addEventListener("change", function () {
        const classId = this.value;
        updateSubclasses(classId);
        updateSkills(classId);
    });
});
</script>